@if (result) {
<div class="min-h-screen bg-[#fafafa]">
  <header class="bg-white border-b border-neutral-200">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a routerLink="/" class="text-lg font-semibold text-neutral-800 hover:text-blue-600 transition-colors">FytAI</a>
        <a routerLink="/feedbacks" class="text-sm text-neutral-600 hover:text-neutral-900 transition-colors">
          {{ 'HOME.VIEW_FEEDBACKS' | translate }}
        </a>
        <a routerLink="/saved-results" class="text-sm text-neutral-600 hover:text-neutral-900 transition-colors">
          {{ 'HOME.SAVED_RESULTS' | translate }}
        </a>
      </div>

      <div class="flex items-center gap-3">
        <div class="relative">
          <button
            (click)="toggleLanguageMenu()"
            class="flex items-center gap-1.5 px-3 py-1.5 text-sm text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-md transition-colors cursor-pointer">
            <lucide-angular [img]="SparklesIcon" class="w-4 h-4"></lucide-angular>
            <span>{{ languageService.getCurrentLanguage().toUpperCase() }}</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          @if (showLanguageMenu) {
            <div class="absolute right-0 mt-1 bg-white border border-neutral-200 rounded-md shadow-sm py-1 min-w-[120px] z-50">
              @for (lang of languages; track lang.code) {
                <button
                  (click)="changeLanguage(lang.code)"
                  class="w-full px-3 py-2 text-sm text-left hover:bg-neutral-50 transition-colors cursor-pointer"
                  [class.bg-neutral-50]="languageService.getCurrentLanguage() === lang.code"
                  [class.font-medium]="languageService.getCurrentLanguage() === lang.code">
                  {{ lang.name }}
                </button>
              }
            </div>
          }
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-8">

    <div class="bg-white border border-neutral-200 rounded-lg overflow-hidden mb-6">
      <div class="p-6 {{ getScoreBgColor(result.scorePercentage) }} text-white">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
          <div class="text-center sm:text-left">
            <h1 class="text-2xl font-semibold mb-1">{{ 'HEALTH.RESULTS_TITLE' | translate }}</h1>
            <p class="text-sm opacity-90">{{ 'HEALTH.RESULTS_SUBTITLE' | translate }}</p>
          </div>

          <div class="text-center">
            <div class="w-24 h-24 rounded-full bg-white/20 backdrop-blur flex items-center justify-center">
              <div>
                <span class="text-4xl font-bold">{{ result.scorePercentage }}</span>
                <span class="text-xl">%</span>
              </div>
            </div>
            <p class="text-xs mt-2 opacity-90">{{ result.totalScore }}/{{ result.maxPossibleScore }} points</p>
          </div>
        </div>
      </div>

      <div class="p-4 border-b border-neutral-100">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 rounded-full text-sm font-medium {{ getHealthLevelColor(result.healthLevel) }}">
              {{ 'HEALTH.LEVEL' | translate }} : {{ getHealthLevelLabel(result.healthLevel) | translate }}
            </span>
            <span class="text-xs text-neutral-500">
              {{ result.completedAt | date:'dd/MM/yyyy HH:mm' }}
            </span>
          </div>
          <div class="flex items-center gap-2">
            <button
              (click)="saveResults()"
              [disabled]="isSaved"
              class="flex items-center gap-1 px-2 sm:px-3 py-1.5 text-sm rounded-md transition-colors cursor-pointer"
              [class.text-neutral-600]="!isSaved"
              [class.hover:text-green-600]="!isSaved"
              [class.hover:bg-green-50]="!isSaved"
              [class.text-green-600]="isSaved"
              [class.bg-green-50]="isSaved"
              [attr.title]="isSaved ? ('HEALTH.SAVED' | translate) : ('HEALTH.SAVE' | translate)">
              <lucide-angular [img]="SaveIcon" class="w-4 h-4"></lucide-angular>
              <span class="hidden sm:inline">{{ isSaved ? ('HEALTH.SAVED' | translate) : ('HEALTH.SAVE' | translate) }}</span>
            </button>
            <button
              (click)="shareOnTwitter()"
              class="flex items-center gap-1 px-2 sm:px-3 py-1.5 text-sm text-neutral-600 hover:text-blue-500 hover:bg-blue-50 rounded-md transition-colors cursor-pointer"
              [attr.title]="'HEALTH.SHARE' | translate">
              <lucide-angular [img]="TwitterIcon" class="w-4 h-4"></lucide-angular>
              <span class="hidden sm:inline">{{ 'HEALTH.SHARE' | translate }}</span>
            </button>
            <button
              (click)="retakeQuestionnaire()"
              class="flex items-center gap-1 px-2 sm:px-3 py-1.5 text-sm text-neutral-600 hover:text-blue-600 transition-colors cursor-pointer"
              [attr.title]="'HEALTH.RETAKE' | translate">
              <lucide-angular [img]="RotateCcwIcon" class="w-4 h-4"></lucide-angular>
              <span class="hidden sm:inline">{{ 'HEALTH.RETAKE' | translate }}</span>
            </button>
          </div>
        </div>
      </div>

      <div class="flex border-b border-neutral-100">
        <button
          (click)="setActiveTab('overview')"
          class="flex-1 px-4 py-3 text-sm font-medium transition-colors cursor-pointer"
          [class.text-blue-600]="activeTab === 'overview'"
          [class.border-b-2]="activeTab === 'overview'"
          [class.border-blue-600]="activeTab === 'overview'"
          [class.text-neutral-500]="activeTab !== 'overview'">
          {{ 'HEALTH.OVERVIEW_TAB' | translate }}
        </button>
        <button
          (click)="setActiveTab('exercises')"
          class="flex-1 px-4 py-3 text-sm font-medium transition-colors cursor-pointer"
          [class.text-blue-600]="activeTab === 'exercises'"
          [class.border-b-2]="activeTab === 'exercises'"
          [class.border-blue-600]="activeTab === 'exercises'"
          [class.text-neutral-500]="activeTab !== 'exercises'">
          {{ 'HEALTH.EXERCISES_TAB' | translate }}
        </button>
      </div>
    </div>

    @if (activeTab === 'overview') {
      <div class="grid sm:grid-cols-2 gap-4 mb-6">
        @for (categoryScore of result.categoryScores; track categoryScore.category) {
          <div class="bg-white border border-neutral-200 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                <lucide-angular [img]="getCategoryIcon(categoryScore.category)" class="w-4 h-4 text-blue-600"></lucide-angular>
              </div>
              <div>
                <h3 class="text-sm font-medium text-neutral-800">
                  {{ getCategoryLabel(categoryScore.category) | translate }}
                </h3>
                <p class="text-xs text-neutral-500">
                  {{ categoryScore.score }}/{{ categoryScore.maxScore }} {{ 'HEALTH.POINTS' | translate }}
                </p>
              </div>
            </div>

            <div class="h-2 bg-neutral-200 rounded-full overflow-hidden">
              <div
                class="h-full rounded-full transition-all duration-1000 {{ getScoreBgColor(categoryScore.percentage) }}"
                [style.width.%]="categoryScore.percentage">
              </div>
            </div>

            <div class="flex justify-between mt-2">
              <span class="text-lg font-bold {{ getScoreColor(categoryScore.percentage) }}">
                {{ categoryScore.percentage }}%
              </span>
              @if (categoryScore.percentage < 60) {
                <span class="text-xs text-amber-600 flex items-center gap-1">
                  <lucide-angular [img]="AlertTriangleIcon" class="w-3 h-3"></lucide-angular>
                  {{ 'HEALTH.TO_IMPROVE' | translate }}
                </span>
              }
            </div>
          </div>
        }
      </div>

      @if (result.riskFactors.length > 0) {
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
          <h3 class="flex items-center gap-2 text-sm font-semibold text-red-700 mb-3">
            <lucide-angular [img]="AlertTriangleIcon" class="w-4 h-4"></lucide-angular>
            {{ 'HEALTH.RISK_FACTORS' | translate }}
          </h3>
          <ul class="space-y-2">
            @for (risk of result.riskFactors; track risk.id) {
              <li class="flex items-center gap-2 text-sm text-red-600">
                <span class="w-1.5 h-1.5 rounded-full {{ risk.severity === 'high' ? 'bg-red-500' : 'bg-amber-500' }}"></span>
                {{ risk.description | translate }}
              </li>
            }
          </ul>
        </div>
      }

      <div class="bg-white border border-neutral-200 rounded-lg p-4 mb-6">
        <h3 class="flex items-center gap-2 text-sm font-semibold text-neutral-800 mb-3">
          <lucide-angular [img]="TargetIcon" class="w-4 h-4 text-blue-500"></lucide-angular>
          {{ 'HEALTH.RECOMMENDATIONS_TITLE' | translate }}
        </h3>
        <ul class="space-y-2">
          @for (recommendation of result.recommendations; track recommendation) {
            <li class="flex items-start gap-2 p-2 bg-neutral-50 rounded-md">
              <lucide-angular [img]="CheckCircleIcon" class="w-4 h-4 text-green-500 shrink-0 mt-0.5"></lucide-angular>
              <span class="text-sm text-neutral-700">{{ recommendation | translate }}</span>
            </li>
          }
        </ul>
      </div>

      @if (feedbackTarget) {
        <div class="mb-6">
          <app-feedback [target]="feedbackTarget"></app-feedback>
        </div>
      }
    }

    @if (activeTab === 'exercises') {
      <div class="space-y-4">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <lucide-angular [img]="SparklesIcon" class="w-5 h-5 text-blue-500"></lucide-angular>
            <h3 class="text-lg font-semibold text-neutral-800">{{ 'HEALTH.AI_RECOMMENDED_EXERCISES' | translate }}</h3>
          </div>
          <button
            (click)="refreshExercises()"
            [disabled]="isLoadingExercises"
            class="flex items-center gap-1.5 px-3 py-1.5 text-sm text-blue-600 hover:bg-blue-50 rounded-md transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
            <lucide-angular [img]="isLoadingExercises ? LoaderIcon : RotateCcwIcon"
                            class="w-4 h-4"
                            [class.animate-spin]="isLoadingExercises"></lucide-angular>
            {{ 'HEALTH.REFRESH_EXERCISES' | translate }}
          </button>
        </div>

        @if (isLoadingExercises) {
          <div class="bg-white border border-neutral-200 rounded-lg p-8 text-center">
            <lucide-angular [img]="LoaderIcon" class="w-8 h-8 text-blue-500 animate-spin mx-auto mb-3"></lucide-angular>
            <p class="text-neutral-600">{{ 'HEALTH.LOADING_EXERCISES' | translate }}</p>
          </div>
        }

        @if (exercisesError && !isLoadingExercises) {
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div class="flex items-center gap-2 text-amber-700 mb-2">
              <lucide-angular [img]="AlertTriangleIcon" class="w-5 h-5"></lucide-angular>
              <span class="font-medium">{{ exercisesError | translate }}</span>
            </div>
            <button
              (click)="refreshExercises()"
              class="px-3 py-1.5 text-sm bg-amber-100 text-amber-700 hover:bg-amber-200 rounded-md transition-colors cursor-pointer">
              {{ 'HEALTH.TRY_AGAIN' | translate }}
            </button>
          </div>
        }

        @if (!isLoadingExercises && aiExercises.length > 0) {
          <div class="space-y-3">
            @for (exercise of aiExercises; track $index) {
              <div class="bg-white border border-neutral-200 rounded-lg overflow-hidden">
                <div
                  (click)="toggleExercise('ai-' + $index)"
                  class="p-4 cursor-pointer hover:bg-neutral-50 transition-colors">
                  <div class="flex items-start justify-between gap-3">
                    <div class="grow">
                      <div class="flex flex-wrap items-center gap-2 mb-2">
                        <span class="px-2 py-0.5 rounded text-xs font-medium {{ getDifficultyColor(exercise.difficulty) }}">
                          {{ getDifficultyLabel(exercise.difficulty) | translate }}
                        </span>
                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-neutral-100 text-neutral-600">
                          {{ getCategoryName(exercise.category) | translate }}
                        </span>
                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-600">
                          <lucide-angular [img]="SparklesIcon" class="w-3 h-3 inline mr-1"></lucide-angular>
                          {{ 'HEALTH.AI_GENERATED' | translate }}
                        </span>
                      </div>
                      <h3 class="text-sm font-medium text-neutral-800 mb-1">
                        {{ exercise.name }}
                      </h3>
                      <p class="text-sm text-neutral-600">
                        {{ exercise.description }}
                      </p>
                      <div class="flex flex-wrap gap-3 mt-2 text-xs text-neutral-500">
                        @if (exercise.duration) {
                          <span class="flex items-center gap-1">
                            <lucide-angular [img]="ClockIcon" class="w-3 h-3"></lucide-angular>
                            {{ exercise.duration }}
                          </span>
                        }
                        @if (exercise.repetitions) {
                          <span class="flex items-center gap-1">
                            <lucide-angular [img]="ActivityIcon" class="w-3 h-3"></lucide-angular>
                            {{ exercise.repetitions }} {{ 'HEALTH.REPS' | translate }}
                          </span>
                        }
                        @if (exercise.sets) {
                          <span class="flex items-center gap-1">
                            <lucide-angular [img]="FlameIcon" class="w-3 h-3"></lucide-angular>
                            {{ exercise.sets }} {{ 'HEALTH.SETS' | translate }}
                          </span>
                        }
                      </div>
                    </div>
                    <lucide-angular
                      [img]="isExerciseExpanded('ai-' + $index) ? ChevronUpIcon : ChevronDownIcon"
                      class="w-5 h-5 text-neutral-400 shrink-0">
                    </lucide-angular>
                  </div>
                </div>

                @if (isExerciseExpanded('ai-' + $index)) {
                  <div class="border-t border-neutral-100 p-4 bg-neutral-50">
                    @if (exercise.benefits && exercise.benefits.length > 0) {
                      <div class="mb-3">
                        <h4 class="text-xs font-medium text-neutral-800 mb-2">{{ 'HEALTH.EXERCISE_BENEFITS' | translate }}</h4>
                        <div class="flex flex-wrap gap-1">
                          @for (benefit of exercise.benefits; track $index) {
                            <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">
                              {{ benefit }}
                            </span>
                          }
                        </div>
                      </div>
                    }

                    @if (exercise.instructions && exercise.instructions.length > 0) {
                      <div class="mb-3">
                        <h4 class="text-xs font-medium text-neutral-800 mb-2">{{ 'HEALTH.EXERCISE_INSTRUCTIONS' | translate }}</h4>
                        <ol class="list-decimal list-inside space-y-1 text-sm text-neutral-600">
                          @for (instruction of exercise.instructions; track $index) {
                            <li>{{ instruction }}</li>
                          }
                        </ol>
                      </div>
                    }

                    @if (exercise.equipment && exercise.equipment.length > 0) {
                      <div class="mt-3">
                        <h4 class="text-xs font-medium text-neutral-800 mb-2">{{ 'HEALTH.EXERCISE_EQUIPMENT' | translate }}</h4>
                        <div class="flex flex-wrap gap-1">
                          @for (equip of exercise.equipment; track $index) {
                            <span class="px-2 py-0.5 bg-neutral-200 text-neutral-700 rounded text-xs">
                              {{ equip }}
                            </span>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }

    <div class="mt-6 text-center">
      <p class="text-sm text-neutral-500 mb-3">
        {{ 'HEALTH.RETAKE_IN_30_DAYS' | translate }}
      </p>
      <a
        routerLink="/"
        class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-neutral-200 text-neutral-700 rounded-md hover:bg-neutral-50 transition-colors text-sm">
        <lucide-angular [img]="ArrowRightIcon" class="w-4 h-4 rotate-180"></lucide-angular>
        {{ 'COMMON.BACK_HOME' | translate }}
      </a>
    </div>

  </main>

  <app-health-chatbot [result]="result" [exercises]="aiExercises"></app-health-chatbot>
</div>
} @else {
  <div class="min-h-screen bg-[#fafafa] flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-3"></div>
      <p class="text-neutral-600 text-sm">{{ 'HEALTH.LOADING' | translate }}</p>
    </div>
  </div>
}
