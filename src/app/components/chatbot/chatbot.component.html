<button
  *ngIf="!isOpen"
  (click)="toggleChat()"
  class="fixed bottom-6 right-6 z-50 flex items-center gap-2 bg-blue-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-blue-700 hover:shadow-xl hover:scale-105 transition-all duration-200 cursor-pointer"
  [attr.aria-label]="'chatbot.openChat' | translate"
>
  <lucide-icon [img]="MessageCircle" class="w-5 h-5"></lucide-icon>
  <span class="hidden sm:inline font-medium text-sm">{{ 'chatbot.buttonText' | translate }}</span>

  <span
    *ngIf="showBadge"
    class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-medium w-5 h-5 rounded-full flex items-center justify-center"
  >
    !
  </span>
</button>

<div
  *ngIf="isOpen"
  class="fixed inset-0 md:inset-auto md:bottom-6 md:right-6 z-50 w-full md:w-[480px] h-full md:h-[700px] md:max-h-[calc(100vh-3rem)] bg-white md:rounded-xl shadow-2xl flex flex-col animate-slideIn"
>
  <div class="bg-white border-b border-neutral-200 px-4 py-3 md:rounded-t-xl flex items-center justify-between shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center shrink-0">
        <lucide-icon [img]="Bot" class="w-4 h-4 text-blue-600"></lucide-icon>
      </div>
      <div>
        <h3 class="text-base font-medium text-neutral-900">{{ 'chatbot.title' | translate }}</h3>
        <p class="text-xs text-neutral-500">{{ 'chatbot.subtitle' | translate }}</p>
      </div>
    </div>
    <button
      (click)="toggleChat()"
      class="text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded-lg p-2 transition-colors shrink-0 cursor-pointer"
      [attr.aria-label]="'chatbot.closeChat' | translate"
    >
      <lucide-icon [img]="X" class="w-5 h-5"></lucide-icon>
    </button>
  </div>

  <div class="chatbot-messages flex-1 overflow-y-auto p-4 space-y-4 bg-neutral-50">
    <div *ngIf="messages.length === 0" class="flex items-start gap-3">
      <div class="shrink-0 w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center">
        <lucide-icon [img]="Bot" class="w-4 h-4 text-blue-600"></lucide-icon>
      </div>
      <div class="flex-1 bg-white p-3 rounded-lg rounded-tl-none border border-neutral-100">
        <p class="text-sm text-neutral-700 leading-relaxed">{{ 'chatbot.welcomeMessage' | translate }}</p>
      </div>
    </div>

    <div *ngIf="showSuggestedQuestions && messages.length === 0" class="space-y-2">
      <p class="text-xs text-neutral-500 font-medium px-1 mb-3">{{ 'chatbot.suggestedQuestionsTitle' | translate }}</p>
      <button
        *ngFor="let question of suggestedQuestions"
        (click)="selectSuggestedQuestion(question)"
        class="w-full text-left bg-white hover:bg-blue-50 text-neutral-700 px-4 py-3 rounded-lg transition-all duration-200 border border-neutral-200 hover:border-blue-300 cursor-pointer"
      >
        <span class="text-sm">{{ question | translate }}</span>
      </button>
    </div>

    <div *ngFor="let message of messages" [ngClass]="message.role === 'user' ? 'flex justify-end' : 'flex items-start gap-3'">
      <div *ngIf="message.role === 'assistant'" class="shrink-0 w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center">
        <lucide-icon [img]="Bot" class="w-4 h-4 text-blue-600"></lucide-icon>
      </div>

      <div
        [ngClass]="{
          'bg-neutral-700 text-white': message.role === 'user',
          'bg-white text-neutral-800 border border-neutral-100': message.role === 'assistant'
        }"
        class="max-w-[85%] sm:max-w-[80%] p-3 rounded-lg"
        [class.rounded-tr-none]="message.role === 'user'"
        [class.rounded-tl-none]="message.role === 'assistant'"
      >
        <p class="text-sm leading-relaxed whitespace-pre-wrap">
          {{ message.content.startsWith('chatbot.') ? (message.content | translate) : message.content }}
        </p>
        <p
          *ngIf="message.timestamp"
          [ngClass]="message.role === 'user' ? 'text-neutral-400' : 'text-neutral-400'"
          class="text-xs mt-1.5"
        >
          {{ message.timestamp | date:'shortTime' }}
        </p>
      </div>
    </div>

    <div *ngIf="isLoading" class="flex items-start gap-3">
      <div class="shrink-0 w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center">
        <lucide-icon [img]="Bot" class="w-4 h-4 text-blue-600"></lucide-icon>
      </div>
      <div class="bg-white p-3 rounded-lg rounded-tl-none border border-neutral-100">
        <div class="flex gap-1">
          <span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
          <span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
          <span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="border-t border-neutral-200 p-4 bg-white md:rounded-b-xl shrink-0">
    <div class="flex gap-2">
      <textarea
        [(ngModel)]="userInput"
        (keypress)="onKeyPress($event)"
        [placeholder]="'chatbot.inputPlaceholder' | translate"
        [disabled]="isLoading"
        class="flex-1 resize-none border border-neutral-300 rounded-lg px-4 py-3 text-sm text-neutral-900 placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-neutral-100 disabled:cursor-not-allowed transition-all"
        rows="2"
      ></textarea>
      <button
        (click)="sendMessage()"
        [disabled]="!userInput.trim() || isLoading"
        class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:bg-neutral-300 disabled:cursor-not-allowed flex items-center justify-center shrink-0 cursor-pointer"
        [attr.aria-label]="'chatbot.sendMessage' | translate"
      >
        <lucide-icon [img]="Send" class="w-5 h-5"></lucide-icon>
      </button>
    </div>
    <p class="text-xs text-neutral-500 mt-2 text-center">
      {{ 'chatbot.hint' | translate }}
    </p>
  </div>
</div>
