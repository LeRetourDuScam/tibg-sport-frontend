<button
  (click)="toggleChat()"
  class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all z-50 cursor-pointer"
  [class.scale-0]="isOpen"
  [attr.aria-label]="'chatbot.openChat' | translate">
  <lucide-angular [img]="MessageCircle" class="w-6 h-6"></lucide-angular>

  @if (showBadge) {
    <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs font-bold animate-pulse">
      1
    </span>
  }
</button>

@if (isOpen) {
  @if (isFullscreen) {
    <div class="fixed inset-0 bg-black/50 z-40" (click)="toggleFullscreen()"></div>
  }

  <div
    class="chat-window fixed z-50 bg-white overflow-hidden flex flex-col transition-all duration-300"
    [class.chat-fullscreen]="isFullscreen"
    [class.chat-normal]="!isFullscreen">

    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-3 flex items-center justify-between shrink-0">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
          <lucide-angular [img]="Bot" class="w-5 h-5"></lucide-angular>
        </div>
        <div>
          <span class="font-medium text-sm block">{{ 'chatbot.title' | translate }}</span>
          <span class="text-xs text-white/70">{{ 'chatbot.subtitle' | translate }}</span>
        </div>
      </div>
      <div class="flex items-center gap-1">
        <button
          (click)="toggleFullscreen()"
          class="p-2 hover:bg-white/20 rounded-lg transition-colors cursor-pointer"
          [attr.aria-label]="isFullscreen ? ('chatbot.exitFullscreen' | translate) : ('chatbot.fullscreen' | translate)">
          <lucide-angular [img]="isFullscreen ? Minimize2 : Maximize2" class="w-4 h-4"></lucide-angular>
        </button>
        <button
          (click)="toggleChat()"
          class="p-2 hover:bg-white/20 rounded-lg transition-colors cursor-pointer"
          [attr.aria-label]="'chatbot.closeChat' | translate">
          <lucide-angular [img]="X" class="w-4 h-4"></lucide-angular>
        </button>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-4 chat-messages-container"
         [class.fullscreen-messages]="isFullscreen">

      @if (messages.length === 0) {
        <div class="flex justify-center">
          <div class="max-w-lg text-center space-y-4 py-8" [class.py-16]="isFullscreen">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto">
              <lucide-angular [img]="Bot" class="w-8 h-8 text-blue-600"></lucide-angular>
            </div>
            <div>
              <h3 class="font-semibold text-lg text-neutral-800 mb-2">{{ 'chatbot.title' | translate }}</h3>
              <p class="text-sm text-neutral-600">
                {{ 'chatbot.welcomeMessage' | translate }}
              </p>
            </div>
          </div>
        </div>
      }

      @if (showSuggestedQuestions && messages.length === 0) {
        <div class="max-w-lg mx-auto space-y-2">
          <p class="text-xs text-neutral-500 font-medium text-center mb-3">{{ 'chatbot.suggestedQuestionsTitle' | translate }}</p>
          <div class="grid gap-2" [class.grid-cols-2]="isFullscreen" [class.grid-cols-1]="!isFullscreen">
            @for (question of suggestedQuestions; track question) {
              <button
                (click)="sendMessage(question)"
                class="text-left text-sm px-4 py-3 bg-neutral-50 hover:bg-blue-50 border border-neutral-200 hover:border-blue-300 rounded-xl transition-all cursor-pointer text-neutral-700 hover:text-blue-700">
                {{ question }}
              </button>
            }
          </div>
        </div>
      }

      <div class="max-w-3xl mx-auto space-y-4" [class.w-full]="!isFullscreen">
        @for (message of messages; track message.timestamp) {
          <div
            class="flex gap-3"
            [class.justify-end]="message.role === 'user'">

            @if (message.role === 'assistant') {
              <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center shrink-0">
                <lucide-angular [img]="Bot" class="w-4 h-4 text-blue-600"></lucide-angular>
              </div>
            }

            <div
              class="max-w-[85%] rounded-2xl px-4 py-3"
              [class.bg-blue-600]="message.role === 'user'"
              [class.text-white]="message.role === 'user'"
              [class.bg-neutral-100]="message.role === 'assistant'"
              [class.text-neutral-800]="message.role === 'assistant'"
              [class.chat-message-fullscreen]="isFullscreen">
              <p class="text-sm whitespace-pre-wrap leading-relaxed">{{ message.content }}</p>
            </div>

            @if (message.role === 'user') {
              <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center shrink-0 text-white text-xs font-medium">
                Moi
              </div>
            }
          </div>
        }

        @if (isLoading) {
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center shrink-0">
              <lucide-angular [img]="Bot" class="w-4 h-4 text-blue-600"></lucide-angular>
            </div>
            <div class="bg-neutral-100 rounded-2xl px-4 py-3">
              <div class="flex items-center gap-2 text-neutral-500">
                <div class="flex gap-1">
                  <span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                  <span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                  <span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                </div>
                <span class="text-xs">{{ 'chatbot.thinking' | translate }}</span>
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <div class="border-t border-neutral-200 p-4 shrink-0 bg-white">
      <div class="max-w-3xl mx-auto">
        <div class="flex gap-3 items-end">
          <div class="flex-1 relative">
            <textarea
              [(ngModel)]="userInput"
              (keydown)="onKeyDown($event)"
              [placeholder]="'chatbot.inputPlaceholder' | translate"
              class="w-full px-4 py-3 text-sm border border-neutral-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all"
              [class.h-12]="!isFullscreen"
              [class.h-14]="isFullscreen"
              [disabled]="isLoading"
              rows="1"></textarea>
          </div>
          <button
            (click)="sendMessage()"
            [disabled]="isLoading || !userInput.trim()"
            class="px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer flex items-center gap-2">
            <lucide-angular [img]="Send" class="w-4 h-4"></lucide-angular>
            @if (isFullscreen) {
              <span class="text-sm">{{ 'chatbot.sendMessage' | translate }}</span>
            }
          </button>
        </div>

        <div class="flex items-center justify-between mt-2">
          @if (messages.length > 0) {
            <button
              (click)="clearHistory()"
              class="flex items-center gap-1 text-xs text-neutral-400 hover:text-red-500 transition-colors cursor-pointer">
              <lucide-angular [img]="Trash2" class="w-3 h-3"></lucide-angular>
              {{ 'chatbot.clearHistory' | translate }}
            </button>
          } @else {
            <span></span>
          }
          @if (isFullscreen) {
            <span class="text-xs text-neutral-400">{{ 'chatbot.hint' | translate }}</span>
          }
        </div>
      </div>
    </div>
  </div>
}
